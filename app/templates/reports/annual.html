{% extends "base.html" %}

{% block title %}דוח שנתי{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-chart-line me-2"></i>דוח שנתי {{ selected_year }}
            </h2>
            <div>
                <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>הדפס
                </button>
                <a href="{{ url_for('reports.export_csv', year=selected_year) }}" class="btn btn-success">
                    <i class="fas fa-file-excel me-2"></i>ייצוא Excel
                </a>
            </div>
        </div>
    </div>
</div>

<!-- בחירת שנה וסינון -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="year" class="form-label">שנה</label>
                <select class="form-select" id="year" name="year" onchange="this.form.submit()">
                    {% for y in range(2020, 2030) %}
                    <option value="{{ y }}" {{ 'selected' if y==selected_year else '' }}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="branch_id" class="form-label">סניף</label>
                <select class="form-select" id="branch_id" name="branch_id" onchange="this.form.submit()">
                    <option value="">כל הסניפים</option>
                    <!-- הוספת רשימת סניפים כאן -->
                </select>
            </div>
        </form>
    </div>
</div>

<!-- תקציר כללי -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">{{ annual_data|length }}</h3>
                <p class="mb-0">סך כל אברכים</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ "%.2f"|format(annual_data|sum(attribute='yearly_total')) }} ₪</h3>
                <p class="mb-0">סך כל תשלומים</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info">{{ "%.2f"|format((annual_data|sum(attribute='yearly_total')) / 12 if annual_data
                    else 0) }} ₪</h3>
                <p class="mb-0">ממוצע חודשי</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning">{{ "%.2f"|format((annual_data|sum(attribute='yearly_total')) /
                    annual_data|length if annual_data else 0) }} ₪</h3>
                <p class="mb-0">ממוצע לאברך</p>
            </div>
        </div>
    </div>
</div>

<!-- טבלת נתונים מפורטת -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>פירוט שנתי לפי אברכים
        </h5>
    </div>
    <div class="card-body">
        {% if annual_data %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>שם מלא</th>
                        <th>ת.ז.</th>
                        <th>סניף</th>
                        <th>ינואר</th>
                        <th>פברואר</th>
                        <th>מרץ</th>
                        <th>אפריל</th>
                        <th>מאי</th>
                        <th>יוני</th>
                        <th>יולי</th>
                        <th>אוגוסט</th>
                        <th>ספטמבר</th>
                        <th>אוקטובר</th>
                        <th>נובמבר</th>
                        <th>דצמבר</th>
                        <th class="table-warning">סך שנתי</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in annual_data %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                    style="width: 35px; height: 35px; font-size: 0.8rem;">
                                    {{ data.avrech.first_name[0] }}{{ data.avrech.last_name[0] }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ data.avrech.full_name }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ data.avrech.id_number }}</td>
                        <td>{{ data.avrech.branch.name if data.avrech.branch else '-' }}</td>
                        {% for month_data in data.monthly_data %}
                        <td class="text-end">
                            <div class="small">{{ "%.0f"|format(month_data.amount) }} ₪</div>
                            <div class="text-muted" style="font-size: 0.7rem;">{{ month_data.present_days }} ימים</div>
                        </td>
                        {% endfor %}
                        <td class="text-end table-warning">
                            <strong>{{ "%.2f"|format(data.yearly_total) }} ₪</strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th colspan="3">סך הכל</th>
                        {% for month in range(1, 13) %}
                        <th class="text-end">
                            {{ "%.0f"|format(annual_data|sum(attribute='monthly_data.' ~ (month-1) ~ '.amount')) }} ₪
                        </th>
                        {% endfor %}
                        <th class="text-end table-warning">
                            <strong>{{ "%.2f"|format(annual_data|sum(attribute='yearly_total')) }} ₪</strong>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-chart-line fa-3x mb-3"></i>
            <h5>אין נתונים לתצוגה</h5>
            <p>לא נמצאו נתונים עבור השנה הנבחרת</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- גרף חודשי -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>התפלגות חודשית
        </h5>
    </div>
    <div class="card-body">
        <canvas id="monthlyChart" width="400" height="200"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // נתונים לגרף
        const monthlyData = [
            {% for month in range(1, 13) %}
        {{ annual_data| sum(attribute = 'monthly_data.' ~(month - 1) ~ '.amount') }},
        {% endfor %}
    ];

    const ctx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'],
            datasets: [{
                label: 'סכום תשלומים (₪)',
                data: monthlyData,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return value.toLocaleString() + ' ₪';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}